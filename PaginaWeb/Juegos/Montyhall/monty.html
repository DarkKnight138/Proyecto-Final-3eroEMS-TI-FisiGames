<?php
session_start();

// Si no estÃ¡ logueado, redirige a login
if (!isset($_SESSION['usuario_id'])) {
    header("Location: ../../backend/login.php");
    exit;
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monty Hall - FisiGames</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"/>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Orbitron', sans-serif; }
    body {
      background: linear-gradient(135deg,#0f0c29,#302b63,#24243e);
      color: #eee;
      min-height: 100vh;
      text-align: center;
    }

    nav#navbar {
      background-color: #1a1a2e;
      color: #eee;
      padding: 0.8rem 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 15px #00ffe7;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .left-section { display:flex; align-items:center; gap:1rem; }
    .logo { color:#00ffe7; font-weight:700; font-size:1.4rem; cursor:pointer; user-select:none; }
    .nav-links { display:flex; gap:1rem; align-items:center; }
    .nav-links a { text-decoration:none; color:#eee; padding:6px 10px; border-radius:6px; font-weight:600; display:flex; gap:8px; align-items:center; }
    .nav-links a:hover { background:#00ffe7; color:#1a1a2e; box-shadow:0 0 8px #00ffe7; }
    .menu-toggle { display:none; flex-direction:column; gap:5px; cursor:pointer; }
    .menu-toggle div { width:25px; height:3px; background:#00ffe7; border-radius:2px; }

    @media (max-width:768px) {
      .nav-links.left-links { display:none; }
      .menu-toggle { display:flex; }
      nav.expanded .nav-links.left-links {
        display:flex; flex-direction:column; position:absolute; top:60px; left:0; width:200px; padding:1rem 1.5rem; background:#1a1a2e; box-shadow:0 0 15px #00ffe7; border-radius:0 0 10px 0;
      }
    }

    main { padding: 100px 1rem 40px; max-width:1100px; margin:0 auto; }

    h2.title {
      font-size:1.8rem;
      color:#ffcc00;
      margin-bottom:1.2rem;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
    }

    .doors {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.2rem;
      align-items:stretch;
      justify-items:center;
      margin: 0 auto;
      max-width:900px;
    }

    .door {
      width:100%;
      max-width:260px;
      aspect-ratio: 1/1.1;
      background:#2c2c3a;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      border: 3px solid transparent;
      font-size:4.2rem;
      user-select:none;
    }
    .door:hover { transform: translateY(-6px); box-shadow:0 10px 28px rgba(0,0,0,0.6); }
    .door.selected { border-color:#00ffe7; box-shadow:0 12px 30px rgba(0,255,231,0.12); }
    .door.opened { transform:none; cursor:default; opacity:1; }
    .door.goat { background:#2b2622; color:#ffddcc; }
    .door.prize { background:#0f5236; color:#fff1c7; box-shadow:0 0 18px #00ffe7; }

    .controls { margin-top:1.4rem; display:flex; gap:1rem; justify-content:center; align-items:center; flex-wrap:wrap; }
    .btn {
      background:transparent; color:#00ffe7; border:2px solid #00ffe7; padding:10px 18px; border-radius:12px; font-weight:700; cursor:pointer;
      transition: all .18s ease;
    }
    .btn:hover { background:#00ffe7; color:#1a1a2e; box-shadow:0 0 10px #00ffe7; transform:translateY(-3px); }
    .btn.primary { background:#00ffe7; color:#1a1a2e; }
    .message { margin-top:1rem; font-weight:700; color:#00ffe7; text-shadow:0 0 8px #00ffe7; min-height:1.2em; }
    .btn-restart { background:#00ffe7; color:#1a1a2e; padding:10px 18px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }

    @media (max-width:560px) {
      .doors { grid-template-columns: 1fr; max-width:320px; }
      .door { max-width:320px; font-size:3.4rem; }
    }
  </style>
</head>
<body>
  <nav id="navbar">
    <div class="left-section">
      <div class="logo">FisiGames</div>
      <div class="nav-links left-links">
        <a href="../../backend/inicio.php"><i class="fa-solid fa-house"></i> Inicio</a>
        <a href="../../backend/puntuaciones.php"><i class="fa-solid fa-trophy"></i> Puntuaciones</a>
        <a href="../../backend/grupos.php"><i class="fa-solid fa-users"></i> Grupos</a>
      </div>
    </div>
    <div class="nav-links right-links">
      <a href="../../backend/perfil.php"><i class="fa-solid fa-user"></i> Perfil</a>
    </div>
    <div class="menu-toggle" id="menu-toggle" aria-label="MenÃº de navegaciÃ³n">
      <div></div><div></div><div></div>
    </div>
  </nav>

  <main>
    <h2 class="title">Monty Hall â€” Elige una puerta</h2>

    <div class="doors" id="doors">
      <div class="door" data-index="0" id="door-0" role="button" aria-label="Puerta 1">ðŸšª</div>
      <div class="door" data-index="1" id="door-1" role="button" aria-label="Puerta 2">ðŸšª</div>
      <div class="door" data-index="2" id="door-2" role="button" aria-label="Puerta 3">ðŸšª</div>
    </div>

    <div class="controls" id="controls" aria-live="polite">
      <button class="btn" id="btn-mantener" style="display:none">Mantener</button>
      <button class="btn" id="btn-cambiar" style="display:none">Cambiar</button>
      <button class="btn-restart" id="btn-reiniciar" style="display:none">Reiniciar</button>
    </div>

    <div class="message" id="message">Elige una puerta para empezar.</div>
  </main>

  <script>
    (function(){
      const doors = Array.from(document.querySelectorAll('.door'));
      const message = document.getElementById('message');
      const btnCambiar = document.getElementById('btn-cambiar');
      const btnMantener = document.getElementById('btn-mantener');
      const btnReiniciar = document.getElementById('btn-reiniciar');
      const menuToggle = document.getElementById('menu-toggle');
      const navbar = document.getElementById('navbar');

      menuToggle?.addEventListener('click', ()=> navbar.classList.toggle('expanded'));

      let prizeDoor = null;
      let playerChoice = null;
      let openedDoor = null;
      let stage = 'idle';

      function initGame(){
        prizeDoor = Math.floor(Math.random()*3);
        playerChoice = null;
        openedDoor = null;
        stage = 'pick';

        doors.forEach((d,i)=>{
          d.className = 'door';
          d.textContent = 'ðŸšª';
          d.onclick = () => elegirPuerta(i);
        });
        btnCambiar.style.display = 'none';
        btnMantener.style.display = 'none';
        btnReiniciar.style.display = 'none';
        message.textContent = 'Elige una puerta para empezar.';
      }

      function elegirPuerta(index){
        if(stage !== 'pick') return;
        playerChoice = index;
        doors.forEach((d,i)=> d.classList.toggle('selected', i===playerChoice));
        abrirPuertaAnfitrion();
      }

      function abrirPuertaAnfitrion(){
        const candidatos = [0,1,2].filter(i => i !== playerChoice && i !== prizeDoor);
        openedDoor = candidatos[Math.floor(Math.random()*candidatos.length)];
        const d = doors[openedDoor];
        d.textContent = 'ðŸ';
        d.classList.add('opened','goat');
        d.onclick = null;

        stage = 'opened';
        message.textContent = 'El anfitriÃ³n abriÃ³ una puerta. Â¿Quieres cambiar tu elecciÃ³n?';
        btnCambiar.style.display = 'inline-block';
        btnMantener.style.display = 'inline-block';

        btnCambiar.onclick = () => finalizar(true);
        btnMantener.onclick = () => finalizar(false);
      }

      function finalizar(usarCambio){
        if(stage !== 'opened') return;
        let finalChoice = playerChoice;
        if(usarCambio){
          finalChoice = [0,1,2].find(i => i !== playerChoice && i !== openedDoor);
        }
        revealAll(finalChoice);
      }

      function revealAll(finalChoice){
        doors.forEach((d,i)=>{
          d.classList.remove('selected');
          d.classList.add('opened');
          d.onclick = null;
          if(i === prizeDoor){
            d.textContent = 'ðŸŽ';
            d.classList.add('prize');
          } else {
            d.textContent = 'ðŸ';
            d.classList.add('goat');
          }
        });

        const win = finalChoice === prizeDoor;
        if(win){
          message.textContent = 'Â¡Ganaste!(+20 puntos)';
          sumarPuntos(20); 
        } else {
          message.textContent = 'Perdiste.';
        }

        btnCambiar.style.display = 'none';
        btnMantener.style.display = 'none';
        btnReiniciar.style.display = 'inline-block';
        stage = 'result';
        btnReiniciar.onclick = initGame;
      }
      function sumarPuntos(puntos){
        fetch("../../backend/controladores/actualizar_puntos.php", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "puntos=" + puntos
        })
        .then(res => res.text())
        .then(data => console.log("Servidor:", data))
        .catch(err => console.error("Error al enviar puntos:", err));
      }

      initGame();
    })();
  </script>
</body>
</html>
